---
# ApplicationSet: MetalLB config (raw YAML từ Git - chỉ cần apply applicationsets)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap-metallb-config
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - name: metallb-config
        repoURL: https://github.com/Hoangvu75/k8s_manifest.git
        targetRevision: master
        path: bootstrap/metallb-config
  template:
    metadata:
      name: '{{name}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: '{{repoURL}}'
        targetRevision: '{{targetRevision}}'
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: metallb-system
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
---
# ApplicationSet for Git-based apps
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: git-apps
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - name: n8n
        namespace: n8n
        repoURL: https://github.com/Hoangvu75/k8s_manifest.git
        targetRevision: master
        path: apps/git-based/n8n
      - name: jenkins
        namespace: jenkins
        repoURL: https://github.com/Hoangvu75/k8s_manifest.git
        targetRevision: master
        path: apps/git-based/jenkins
  template:
    metadata:
      name: '{{name}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: '{{repoURL}}'
        targetRevision: '{{targetRevision}}'
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
---
# ApplicationSet for Helm-based apps (ingress-nginx)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: helm-app-ingress-nginx
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - name: ingress-nginx
        namespace: ingress-nginx
  template:
    metadata:
      name: ingress-nginx
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://kubernetes.github.io/ingress-nginx
        targetRevision: 4.11.3
        chart: ingress-nginx
        helm:
          releaseName: ingress-nginx
          values: |
            controller:
              service:
                type: LoadBalancer
                loadBalancerIP: 192.168.56.200
              config:
                use-forwarded-headers: "true"
              metrics:
                enabled: true
      destination:
        server: https://kubernetes.default.svc
        namespace: ingress-nginx
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
---
# ApplicationSet for Helm-based apps (metallb)
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: helm-app-metallb
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - name: metallb
        namespace: metallb-system
  template:
    metadata:
      name: metallb
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://metallb.github.io/metallb
        targetRevision: 0.14.8
        chart: metallb
        helm:
          releaseName: metallb
          values: |
            speaker:
              frr:
                enabled: false
      destination:
        server: https://kubernetes.default.svc
        namespace: metallb-system
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
