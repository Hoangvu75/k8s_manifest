apiVersion: batch/v1
kind: CronJob
metadata:
  name: speedtest
  namespace: test
spec:
  schedule: "@yearly"  # Disabled - chỉ trigger thủ công
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: speedtest
            image: curlimages/curl:latest
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              echo "=== Network Speed Test ==="
              echo "Testing download speed with 10MB file..."
              START_TIME=$(date +%s.%3N)
              # Get all metrics in one curl call
              OUTPUT=$(curl -s -o /dev/null -w "%{speed_download}|%{time_total}|%{size_download}" http://speedtest.tele2.net/10MB.zip)
              SPEED_BYTES=$(echo "$OUTPUT" | cut -d'|' -f1)
              TIME_TOTAL=$(echo "$OUTPUT" | cut -d'|' -f2)
              SIZE_BYTES=$(echo "$OUTPUT" | cut -d'|' -f3)

              # Convert to MB/s (bytes/sec to MB/s)
              SPEED_MBPS=$(echo "scale=2; $SPEED_BYTES / 1048576" | bc -l 2>/dev/null || echo "N/A")
              # Format to remove leading zero if it's less than 1
              SPEED_MBPS_FORMATTED=$(echo "$SPEED_MBPS" | sed 's/^\./0./')

              echo "Download Speed: ${SPEED_MBPS_FORMATTED} MB/s"
              echo "Total Time: ${TIME_TOTAL}s"
              echo "File Size: ${SIZE_BYTES} bytes"
              END_TIME=$(date +%s.%3N)
              DURATION=$(echo "$END_TIME - $START_TIME" | bc -l 2>/dev/null || echo "N/A")
              echo "Test Duration: ${DURATION}s"

              echo ""
              echo "=== Ping Test ==="
              echo "Testing latency to google.com..."
              ping -c 4 google.com | tail -1

              echo ""
              echo "=== DNS Resolution Test ==="
              echo "Resolving docker.io..."
              nslookup docker.io 2>/dev/null || echo "nslookup not available, trying getent..."
              getent hosts docker.io 2>/dev/null || echo "DNS resolution test completed"
