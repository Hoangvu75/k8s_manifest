suite: test statefulset
templates:
  - statefulset.yaml
tests:
  - it: should not create StatefulSet when disabled
    set:
      statefulset.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create StatefulSet when enabled
    set:
      statefulset.enabled: true
      statefulset.image.repository: "nginx"
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-application

  - it: should set replicas correctly
    set:
      statefulset.enabled: true
      statefulset.replicas: 3
      statefulset.image.repository: "nginx"
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should create volumeClaimTemplates when specified
    set:
      statefulset.enabled: true
      statefulset.image.repository: "nginx"
      statefulset.volumeClaimTemplates:
        - metadata:
            name: data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: "10Gi"
            storageClassName: "fast-ssd"
          mountPath: "/var/lib/data"
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: data
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: "10Gi"

  - it: should set service account when rbac is enabled
    set:
      statefulset.enabled: true
      statefulset.image.repository: "nginx"
      rbac.serviceAccount.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-application
