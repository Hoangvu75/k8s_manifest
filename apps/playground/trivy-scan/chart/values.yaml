# Trivy K8s scan - chỉ chạy CronJob (scan cluster), không Deployment.
# Trigger tay: kubectl create job trivy-scan-manual-1 --from=cronjob/scan -n trivy-scan
applicationName: trivy-scan

rbac:
  enabled: true
  serviceAccount:
    enabled: true
    name: trivy-scan

# CronJob theo template helm_application
cronJob:
  enabled: true
  jobs:
    scan:
      schedule: "0 2 * * *"
      concurrencyPolicy: Forbid
      successfulJobsHistoryLimit: 1
      failedJobsHistoryLimit: 2
      backoffLimit: 0
      image:
        repository: harbor.hoangvu75.space/library/trivy-scan
        tag: "d7f8758"
        imagePullPolicy: Always
      # Không override command/args: dùng CMD mặc định (python3 /app/app.py). Env TRIVY_CRON=1 khiến app chạy scan rồi thoát.
      envFrom:
        - secretRef:
            name: trivy-scan-secret
      env:
        TRIVY_CRON:
          value: "1"
        # Không set TRIVY_SKIP_IMAGES → quét đầy đủ (misconfig + vuln image). Xem log trong pod.
        TRIVY_CACHE_DIR:
          value: "/tmp/trivy-cache"
        XDG_CACHE_HOME:
          value: "/tmp/trivy-cache"
      volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi

deployment:
  enabled: false

persistence:
  enabled: false

service:
  enabled: false

ingress:
  enabled: false
