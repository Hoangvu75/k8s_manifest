# Trivy K8s manifest scan service - Scan all playground apps, post to Discord
# Cấu trúc theo helm_application: rbac.serviceAccount + extraObjects (ClusterRole)
applicationName: trivy-scan

rbac:
  enabled: true
  serviceAccount:
    enabled: true
    name: trivy-scan
  # ClusterRole dùng extraObjects bên dưới (chart chỉ có Role namespaced)

# ClusterRole + ClusterRoleBinding cho trivy k8s (scan cluster) — đưa vào chart qua extraObjects
extraObjects:
  - |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: trivy-scan-cluster-reader
    rules:
      - apiGroups: [""]
        resources: ["*"]
        verbs: ["list", "get"]
      # Trivy k8s (with node info) cần create/delete namespaces tạm
      - apiGroups: [""]
        resources: ["namespaces"]
        verbs: ["list", "get", "create", "delete"]
      - apiGroups: ["apps"]
        resources: ["*"]
        verbs: ["list", "get"]
      - apiGroups: ["batch"]
        resources: ["*"]
        verbs: ["list", "get"]
      - apiGroups: ["networking.k8s.io"]
        resources: ["*"]
        verbs: ["list", "get"]
      - apiGroups: ["rbac.authorization.k8s.io"]
        resources: ["*"]
        verbs: ["list", "get"]
      - apiGroups: ["admissionregistration.k8s.io"]
        resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
        verbs: ["list", "get"]
  - |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: trivy-scan-cluster-reader
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: trivy-scan-cluster-reader
    subjects:
      - kind: ServiceAccount
        name: trivy-scan
        namespace: {{ .Release.Namespace }}

deployment:
  enabled: true
  replicas: 1
  image:
    repository: harbor.hoangvu75.space/library/trivy-scan
    tag: "8885ec9"
    pullPolicy: Always
  ports:
    - containerPort: 8080
      name: http
  envFrom:
    - type: secret
      name: trivy-scan-secret
  containerSecurityContext:
    runAsNonRoot: false
  env:
    PORT:
      value: "8080"
    # Trivy cần thư mục ghi được cho cache/checks (container read-only root)
    TRIVY_CACHE_DIR:
      value: "/tmp/trivy-cache"
    XDG_CACHE_HOME:
      value: "/tmp/trivy-cache"
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 5
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  # Thư mục tạm để scan (clone repo, trivy) - tránh FileNotFoundError: No usable temporary directory
  volumes:
    tmp:
      emptyDir: {}
  volumeMounts:
    tmp:
      mountPath: /tmp

persistence:
  enabled: false

service:
  enabled: true
  ports:
    - port: 80
      targetPort: 8080
      name: http

ingress:
  enabled: false
